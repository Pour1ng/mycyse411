name: DAST - OWASP ZAP Full Scan

on:
  workflow_dispatch:    # run manually from Actions tab

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Don't stop other scans if one fails
      matrix:
        include:
          # 1. Original FastBank Lab (Keep this working!)
          - name: FastBank Insecure
            work_dir: fastbank_insecure_classwork/backend
            port: 4000
          
          # 2. Canonicalization Lab (Task 1)
          - name: Canonicalization Lab
            work_dir: canonicalization-example
            port: 3000   # <--- CHECK THIS PORT in server.js

          # 3. IDOR Lab (Task 1)
          - name: IDOR Lab
            work_dir: idor
            port: 3000   # <--- CHECK THIS PORT in server.js

          # 4. FastBank Auth Lab (Task 1)
          - name: FastBank Auth Lab
            work_dir: fastbank-auth-lab
            port: 4000   # <--- CHECK THIS PORT in server.js

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # We use the matrix variables here to make it dynamic
      - name: Install dependencies for ${{ matrix.name }}
        working-directory: ${{ matrix.work_dir }}
        run: |
          if [ -f package.json ]; then npm install; else echo "No package.json found, skipping install"; fi

      - name: Start ${{ matrix.name }}
        working-directory: ${{ matrix.work_dir }}
        run: |
          npm start &
          # Wait for server to boot
          sleep 20

      - name: Run OWASP ZAP Full Scan on ${{ matrix.name }}
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: 'http://127.0.0.1:${{ matrix.port }}'
          fail_action: true    # fail job if ZAP finds alerts
          allow_issue_writing: false 
          artifact_name: zap_scan_${{ matrix.name }}  # Saves separate reports for each lab
